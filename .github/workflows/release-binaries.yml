name: Release binaries

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (e.g. v0.3.0). If empty, uses the workflow ref."
        required: false
        default: ""

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.label }})
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            label: linux-x86_64
          # Linux ARM64 hosted runners are available for public repos.
          - runner: ubuntu-24.04-arm
            label: linux-arm64
          - runner: macos-latest
            label: darwin-arm64
          - runner: macos-13
            label: darwin-x86_64
          - runner: windows-latest
            label: windows-amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref || github.ref_name }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Verify tag matches package.json version
        if: startsWith(github.ref, 'refs/tags/') || (inputs.ref != '' && startsWith(inputs.ref, 'v'))
        shell: bash
        run: |
          TAG_REF="${{ inputs.ref || github.ref_name }}"
          TAG="${TAG_REF#v}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$PKG_VERSION" != "$TAG" ]; then
            echo "package.json version '$PKG_VERSION' does not match tag '$TAG'"
            exit 1
          fi

      - name: Build dist
        run: bun run dist:build

      - name: Package (macOS/Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH_RAW=$(uname -m | tr '[:upper:]' '[:lower:]')

          case "$ARCH_RAW" in
            x86_64|amd64)
              ARCH="x86_64"
              ;;
            arm64|aarch64)
              ARCH="arm64"
              ;;
            *)
              ARCH="$ARCH_RAW"
              ;;
          esac

          REF_NAME="${{ inputs.ref || github.ref_name }}"

          ASSET_VERSIONED="haakweeroverzicht-tui-${REF_NAME}-${OS}-${ARCH}.tar.gz"
          ASSET_LATEST="haakweeroverzicht-tui-latest-${OS}-${ARCH}.tar.gz"

          tar -czf "$ASSET_VERSIONED" -C dist .
          cp -f "$ASSET_VERSIONED" "$ASSET_LATEST"

          echo "ASSET_VERSIONED=$ASSET_VERSIONED" >> "$GITHUB_ENV"
          echo "ASSET_LATEST=$ASSET_LATEST" >> "$GITHUB_ENV"

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ref = "${{ inputs.ref || github.ref_name }}"
          $archRaw = $env:PROCESSOR_ARCHITECTURE.ToLower()

          $arch = switch ($archRaw) {
            'amd64' { 'amd64' }
            'arm64' { 'arm64' }
            default { $archRaw }
          }

          $assetVersioned = "haakweeroverzicht-tui-$ref-windows-$arch.zip"
          $assetLatest = "haakweeroverzicht-tui-latest-windows-$arch.zip"

          Compress-Archive -Path dist\* -DestinationPath $assetVersioned
          Copy-Item -Force $assetVersioned $assetLatest

          "ASSET_VERSIONED=$assetVersioned" | Out-File -FilePath $env:GITHUB_ENV -Append
          "ASSET_LATEST=$assetLatest" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-${{ matrix.label }}
          path: |
            ${{ env.ASSET_VERSIONED }}
            ${{ env.ASSET_LATEST }}

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/') || (inputs.ref != '' && startsWith(inputs.ref, 'v'))

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: List artifacts
        shell: bash
        run: |
          find release-artifacts -type f -maxdepth 3 -print

      - name: Upload to GitHub Release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          TAG="${{ inputs.ref || github.ref_name }}"
          REPO="${GITHUB_REPOSITORY}"

          if ! gh release view "$TAG" --repo "$REPO" >/dev/null 2>&1; then
            gh release create "$TAG" --repo "$REPO" --title "$TAG" --notes ""
          fi

          gh release upload "$TAG" --repo "$REPO" release-artifacts/**/*.tar.gz release-artifacts/**/*.zip --clobber
